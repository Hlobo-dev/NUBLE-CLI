# Nova Sonic Debug Environment

## Overview

This is a local debug environment to reproduce and diagnose timeout issues with Amazon Nova Sonic (speech-to-speech) bidirectional streaming.

**Customer Issue:** Sessions timing out at ~110 seconds with error:
```
"Timed out waiting for input events"
```

---

## ğŸ—ï¸ Complete AWS Architecture

### Customer's Production Architecture (What They're Running)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CUSTOMER PRODUCTION ARCHITECTURE                                  â”‚
â”‚                                     (Breakthrough Beverage Sales Coach)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚                                         FRONTEND LAYER                                       â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                           â”‚  â”‚
â”‚    â”‚  â”‚              â”‚     HTTPS / WSS                                                           â”‚  â”‚
â”‚    â”‚  â”‚   Browser    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚    â”‚  â”‚   (React/    â”‚                                                                      â”‚    â”‚  â”‚
â”‚    â”‚  â”‚    Vue/JS)   â”‚     Audio: 16kHz, 16-bit, Mono, PCM, Base64 encoded                 â”‚    â”‚  â”‚
â”‚    â”‚  â”‚              â”‚     ~31 chunks/second from microphone                                â”‚    â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â”‚    â”‚  â”‚
â”‚    â”‚         â”‚                                                                              â”‚    â”‚  â”‚
â”‚    â”‚         â”‚ getUserMedia() â†’ AudioWorklet â†’ PCM â†’ Base64                                â”‚    â”‚  â”‚
â”‚    â”‚         â”‚                                                                              â”‚    â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                                                                              â”‚       â”‚
â”‚              â–¼                                                                              â”‚       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚                                    AWS APPSYNC EVENTS                                        â”‚  â”‚
â”‚    â”‚                              (Real-time WebSocket Pub/Sub)                                   â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Channel: /audio/{sessionId}/input     â”€â”€â”€â”€â”€â”€â–º  Audio chunks TO backend             â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Channel: /audio/{sessionId}/output    â—„â”€â”€â”€â”€â”€â”€  Audio chunks FROM backend           â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Channel: /audio/{sessionId}/events    â—„â”€â”€â”€â”€â”€â”€  Status, errors, transcripts         â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ WebSocket connection maintained by client                                         â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ IAM or Cognito authentication                                                     â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ Auto-reconnect on disconnect                                                      â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â”‚                                           â”‚                                                  â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚                                                     â”‚
â”‚                                                â”‚ AppSync Event Subscription                          â”‚
â”‚                                                â”‚ (appsync-client.js)                                 â”‚
â”‚                                                â–¼                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚                                      COMPUTE LAYER                                           â”‚  â”‚
â”‚    â”‚                              AWS ECS / Fargate (Long-Running)                                â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Container: nova-sonic-agent                                                         â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Image: ECR repository                                                               â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   CPU: 1 vCPU | Memory: 2GB | Platform: Linux/ARM64 or x86_64                        â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                         index.js (Main Entry Point)                          â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Subscribes to AppSync Events channels                                    â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Manages multiple concurrent sessions (Map<sessionId, NovaStream>)        â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Audio batching: MIN=10, MAX=20 chunks, TIMEOUT=100ms                     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Session resume: MAX_ATTEMPTS=3 with exponential backoff                  â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Graceful shutdown on SIGTERM/SIGINT                                      â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                           â”‚                                          â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                           â–¼                                          â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                   nova-stream.js (NovaStream Class)                          â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   BedrockRuntimeClient Configuration:                                        â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”‚  requestHandler: NodeHttp2Handler({                               â”‚     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”‚    requestTimeout: 900000,    // 15 min (fixes 120s default)      â”‚     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”‚    sessionTimeout: 900000,    // 15 min                           â”‚     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”‚    disableConcurrentStreams: false,                               â”‚     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”‚    maxConcurrentStreams: 1                                        â”‚     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â”‚  })                                                               â”‚     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   Key Features:                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Async iterator for bidirectional streaming                               â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Event queue for outbound events to Bedrock                               â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Audio input queue with overflow protection (MAX=200)                     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ 30-second keep-alive (silent audio chunks)                               â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Chat history slicing for session resume                                  â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Audio flow instrumentation (stats every 5s)                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                           â”‚                                          â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                           â–¼                                          â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                   appsync-client.js (Event Publisher)                        â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Publishes audio output back to AppSync                                   â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Sends transcripts, errors, status updates                                â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Uses AWS SDK v3 with SigV4 signing                                       â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â”‚                                           â”‚                                                  â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚                                                     â”‚
â”‚                                                â”‚ HTTP/2 Bidirectional Stream                         â”‚
â”‚                                                â”‚ InvokeModelWithBidirectionalStreamCommand           â”‚
â”‚                                                â–¼                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚                                    AMAZON BEDROCK                                            â”‚  â”‚
â”‚    â”‚                              Nova Sonic (Speech-to-Speech)                                   â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Model ID: amazon.nova-2-sonic-v1:0                                                  â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Region: us-east-1                                                                   â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                         INPUT CONFIGURATION                                  â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   Audio Input:                                                               â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Type: SPEECH                                                             â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Encoding: base64                                                         â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Media Type: audio/lpcm                                                   â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Sample Rate: 16000 Hz                                                    â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Sample Size: 16 bits                                                     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Channels: 1 (mono)                                                       â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   Inference Configuration:                                                   â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ maxTokens: 256                                                           â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ topP: 0.9                                                                â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ temperature: 0.8                                                         â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                         OUTPUT CONFIGURATION                                 â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   Audio Output:                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Type: SPEECH                                                             â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Encoding: base64                                                         â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Media Type: audio/lpcm                                                   â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Sample Rate: 24000 Hz                                                    â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Sample Size: 16 bits                                                     â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Channels: 1 (mono)                                                       â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Voice ID: matthew (or configurable)                                      â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   Text Output:                                                               â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ Media Type: text/plain                                                   â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚   â€¢ (Transcripts of speech)                                                  â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Session Limits:                                                                     â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ Maximum session duration: ~8 minutes                                              â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ Timeout if no input: Configurable (error at ~110s = "Timed out waiting...")       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â”‚                                                                                              â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚                                      DATA LAYER                                              â”‚  â”‚
â”‚    â”‚                                   Amazon DynamoDB                                            â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Table: ChatHistory (or similar)                                                     â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Schema:                                                                             â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚  PK: sessionId (String)                                                      â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚  SK: timestamp (Number)                                                      â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚  Attributes:                                                                 â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚  â€¢ role: "USER" | "ASSISTANT"                                                â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚  â€¢ content: String (transcript)                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚  â€¢ createdAt: ISO timestamp                                                  â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â”‚                                                                              â”‚    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   Used for:                                                                           â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ Session resume after disconnect                                                   â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ Conversation continuity across reconnects                                         â”‚  â”‚  â”‚
â”‚    â”‚  â”‚   â€¢ Audit/compliance logging                                                          â”‚  â”‚  â”‚
â”‚    â”‚  â”‚                                                                                       â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â”‚                                                                                              â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Event Flow Sequence Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Browser â”‚          â”‚ AppSync â”‚          â”‚  ECS    â”‚          â”‚ Bedrock â”‚          â”‚ DynamoDB â”‚
â”‚        â”‚          â”‚ Events  â”‚          â”‚Containerâ”‚          â”‚  Nova   â”‚          â”‚          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚  1. Connect WSS    â”‚                    â”‚                    â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚  2. Subscribe      â”‚                    â”‚                    â”‚                    â”‚
    â”‚   /audio/{id}/*    â”‚                    â”‚                    â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚  3. Event Sub      â”‚                    â”‚                    â”‚
    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚  4. Publish audio  â”‚                    â”‚                    â”‚                    â”‚
    â”‚   chunk (base64)   â”‚                    â”‚                    â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚  5. Deliver event  â”‚                    â”‚                    â”‚
    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚  6. Batch audio    â”‚                    â”‚
    â”‚                    â”‚                    â”‚  (10-20 chunks)    â”‚                    â”‚
    â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚  7. Send to stream â”‚                    â”‚
    â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚  8. AI processes   â”‚                    â”‚
    â”‚                    â”‚                    â”‚  speech & responds â”‚                    â”‚
    â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚  9. Save transcriptâ”‚                    â”‚
    â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚  10. Publish audio â”‚                    â”‚                    â”‚
    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚  11. Receive audio â”‚                    â”‚                    â”‚                    â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
    â”‚  12. Play through  â”‚                    â”‚                    â”‚                    â”‚
    â”‚  AudioWorklet      â”‚                    â”‚                    â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚                    â”‚                    â”‚
```

### Local Debug Architecture (This Repository)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    LOCAL DEBUG ENVIRONMENT                                           â”‚
â”‚                                     (Simplified for Testing)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚                                    YOUR MACHINE                                           â”‚     â”‚
â”‚    â”‚                                                                                           â”‚     â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Socket.IO          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚    â”‚   â”‚              â”‚        (WebSocket)         â”‚                                     â”‚   â”‚     â”‚
â”‚    â”‚   â”‚   Chrome     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      local-server.js                â”‚   â”‚     â”‚
â”‚    â”‚   â”‚   Browser    â”‚     localhost:3000         â”‚                                     â”‚   â”‚     â”‚
â”‚    â”‚   â”‚              â”‚                            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚   â”‚   nova-stream-customer.js   â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”‚  Mic   â”‚  â”‚   Audio: 16kHz PCM         â”‚   â”‚   (EXACT customer code)     â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”‚  ğŸ¤    â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   â”‚                             â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚   â”‚   â€¢ Same NovaStream class   â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚              â”‚                            â”‚   â”‚   â€¢ Same timeout settings   â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   Audio: 24kHz PCM         â”‚   â”‚   â€¢ Same keep-alive logic   â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”‚Speaker â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚                             â”‚   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”‚  ğŸ”Š    â”‚  â”‚                            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚                  â”‚                  â”‚   â”‚     â”‚
â”‚    â”‚   â”‚              â”‚                            â”‚                  â”‚ HTTP/2           â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚                  â”‚                  â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”‚ Debug  â”‚  â”‚   Stats every 5s           â”‚                  â–¼                  â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â”‚ Panel  â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚     â”‚
â”‚    â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚         â”‚   AWS Bedrock â”‚          â”‚   â”‚     â”‚
â”‚    â”‚   â”‚              â”‚                            â”‚         â”‚   Nova Sonic  â”‚          â”‚   â”‚     â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚         â”‚   us-east-1   â”‚          â”‚   â”‚     â”‚
â”‚    â”‚                                               â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚     â”‚
â”‚    â”‚                                               â”‚                                     â”‚   â”‚     â”‚
â”‚    â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚    â”‚                                                                                           â”‚     â”‚
â”‚    â”‚   Replaces:                                                                               â”‚     â”‚
â”‚    â”‚   âœ— AppSync Events  â†’  âœ“ Socket.IO                                                       â”‚     â”‚
â”‚    â”‚   âœ— DynamoDB        â†’  âœ“ In-memory Map                                                   â”‚     â”‚
â”‚    â”‚   âœ— ECS/Fargate     â†’  âœ“ Local Node.js                                                   â”‚     â”‚
â”‚    â”‚                                                                                           â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Findings Summary

### âœ… Successfully Reproduced & Fixed

After testing with the customer's exact architecture:

| Test | Duration | Result |
|------|----------|--------|
| Test 1 | 5m 9s (309 seconds) | âœ… Success - No timeout |
| Audio In | 9,644 chunks sent to Bedrock | âœ… Working |
| Audio Out | 2,356 chunks received from Bedrock | âœ… Working |

### Root Cause Analysis

The customer's code **already contains** the timeout fix (`requestTimeout: 900000`, `sessionTimeout: 900000`). The local reproduction worked without issues.

**Possible causes for their production ~110s timeout:**

1. **Deployment mismatch** - Production container may have older code without the fix
2. **Infrastructure timeout** - AppSync, API Gateway, ALB, or CloudFront has a timeout configured
3. **Bedrock-side timeout** - If no audio is sent for extended periods, Bedrock times out waiting for input

### Key Configuration (Already in Customer Code)

```javascript
this.client = new BedrockRuntimeClient({
  region: process.env.BEDROCK_REGION || 'us-east-1',
  requestHandler: new NodeHttp2Handler({
    requestTimeout: 900000,     // 15 min - prevents Node.js HTTP/2 120s default
    sessionTimeout: 900000,     // 15 min - prevents session timeout
    disableConcurrentStreams: false,
    maxConcurrentStreams: 1,
  }),
});
```

### Additional Fix: Keep-Alive

The customer's code also includes a 30-second keep-alive that sends silent audio chunks to Bedrock when the queue is empty:

```javascript
_startBedrockKeepAlive() {
  this._bedrockKeepAliveInterval = setInterval(() => {
    if (this.eventQueue.length === 0) {
      // 10ms of silence at 16kHz, 16-bit mono = 320 bytes
      const silentChunk = Buffer.alloc(320).toString('base64');
      this.eventQueue.push({
        event: {
          audioInput: {
            promptName: this.promptName,
            contentName: this.audioContentId,
            content: silentChunk,
          },
        },
      });
    }
  }, 30000); // Every 30 seconds
}
```

## Architecture Tested

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOCAL DEBUG ENVIRONMENT                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Socket.IO    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                          â”‚  â”‚
â”‚  â”‚   Browser    â”‚                 â”‚    local-server.js       â”‚  â”‚
â”‚  â”‚  (Frontend)  â”‚                 â”‚  (Customer's exact code) â”‚  â”‚
â”‚  â”‚              â”‚                 â”‚                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚                 â”‚
â”‚                                                â”‚ HTTP/2          â”‚
â”‚                                                â”‚ Bidirectional   â”‚
â”‚                                                â–¼                 â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                   â”‚                          â”‚  â”‚
â”‚                                   â”‚   Amazon Bedrock         â”‚  â”‚
â”‚                                   â”‚   Nova Sonic             â”‚  â”‚
â”‚                                   â”‚   (us-east-1)            â”‚  â”‚
â”‚                                   â”‚                          â”‚  â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Replaces in local testing:**
- AppSync Events â†’ Socket.IO
- DynamoDB â†’ In-memory chat history
- ECS/Fargate â†’ Local Node.js process

## Files

| File | Description |
|------|-------------|
| `local-server.js` | Socket.IO server using customer's NovaStream class |
| `src/nova-stream-customer.js` | Exact copy of customer's NovaStream implementation |
| `public/index.html` | Frontend UI for testing |
| `public/src/main.js` | Frontend JavaScript with debug instrumentation |
| `.env` | AWS credentials (not committed) |

## Running Locally

1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Configure AWS credentials** in `.env`:
   ```
   AWS_ACCESS_KEY_ID=your_key
   AWS_SECRET_ACCESS_KEY=your_secret
   AWS_REGION=us-east-1
   ```

3. **Start the server:**
   ```bash
   npm run start:customer
   ```

4. **Open browser:**
   ```
   http://localhost:3000
   ```

5. **Test:**
   - Click "Start Streaming"
   - Speak into your microphone
   - Watch the debug panel for timing and audio flow
   - Try to reproduce the ~110s timeout

## Debug Panel

The UI includes a debug panel showing:
- **Elapsed Time** - How long the session has been running
- **Audio In** - Chunks received from microphone
- **Sent to Bedrock** - Chunks sent to Nova Sonic
- **From Bedrock** - Response chunks from Nova Sonic
- **Audio Out** - Chunks played back to user
- **Session Status** - Current connection state

## Recommendations for Customer

1. **Verify deployment** - Ensure the production container has the latest code with timeout settings

2. **Check infrastructure timeouts:**
   - AppSync: Default 30s, can be increased
   - API Gateway: Default 29s (WebSocket), 30s (REST)
   - ALB: Default 60s idle timeout
   - CloudFront: Origin timeout settings

3. **Add CloudWatch logging** - Log the exact timestamp when the error occurs to correlate with infrastructure logs

4. **Test with CloudWatch Logs Insights:**
   ```
   fields @timestamp, @message
   | filter @message like /Timed out/
   | sort @timestamp desc
   | limit 100
   ```

## AWS Account Used for Testing

- Account: 456309723884
- Region: us-east-1
- Model: amazon.nova-2-sonic-v1:0

---

*Generated by AWS TAM debugging session - February 2026*
