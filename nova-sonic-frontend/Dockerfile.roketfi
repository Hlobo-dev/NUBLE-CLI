# ============================================================
# ROKETFI Production Dockerfile
# Multi-stage build: 
#   Stage 1: Build SvelteKit frontend
#   Stage 2: Production — Node.js backend + Python ROKET API
#
# Architecture (mirrors localhost exactly):
#   - Node.js server.js on port 3000 (frontend + API proxy + WebSocket)
#   - Python ROKET FastAPI on port 8000 (ML predictions + financial intelligence)
#   - supervisord manages both processes
# ============================================================

# ---- Stage 1: Production Frontend ----
# Use the verified production frontend build from the 07dd180 image
# This is the exact build running on roketfi.com with correct sidebar UI
FROM 456309723884.dkr.ecr.us-east-1.amazonaws.com/roket-production:07dd180 AS frontend-source

# ---- Stage 2: Production (Node.js + Python) ----
FROM node:20-slim AS production

# Install Python 3, pip, supervisor, and build essentials for native Python packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    supervisor \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -g 1001 roket && \
    useradd -u 1001 -g roket -m -s /bin/bash roket

WORKDIR /app

# ── Python ROKET API Setup ──

# Create Python virtual environment
RUN python3 -m venv /app/venv
ENV PATH="/app/venv/bin:$PATH"

# Install Python dependencies
COPY pyproject.toml /app/pyproject.toml
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
    fastapi \
    "uvicorn[standard]" \
    numpy \
    pandas \
    requests \
    aiohttp \
    httpx \
    python-dotenv \
    rich \
    pydantic \
    lightgbm \
    scikit-learn \
    scipy \
    joblib \
    statsmodels \
    hmmlearn \
    fredapi \
    boto3 \
    polygon-api-client \
    pyarrow

# Copy Python source code
COPY src/ /app/src/

# Copy trained ML models
COPY models/ /app/models/

# Set Python path so nuble package is importable
ENV PYTHONPATH="/app/src:/app"

# ── Node.js Backend Setup ──

# Install Node.js dependencies first (layer caching)
COPY nova-sonic-frontend/nuble-backend/package.json nova-sonic-frontend/nuble-backend/package-lock.json* /app/node/
WORKDIR /app/node
RUN npm ci --omit=dev 2>/dev/null || npm install --omit=dev && npm cache clean --force

# Copy backend source (ALL .js files — server.js, nuble-tools.js, nova-sonic-client.js)
COPY nova-sonic-frontend/nuble-backend/server.js /app/node/
COPY nova-sonic-frontend/nuble-backend/nuble-tools.js /app/node/
COPY nova-sonic-frontend/nuble-backend/nova-sonic-client.js /app/node/

# Copy static assets (favicons, logos)
COPY nova-sonic-frontend/nuble-backend/static/ /app/node/static/

# Copy verified production frontend from the 07dd180 image
COPY --from=frontend-source /app/frontend-build /app/frontend-build

# ── Data & Config ──

# Create writable data directory
RUN mkdir -p /app/data /app/logs && chown -R roket:roket /app/data /app/logs

WORKDIR /app

# ── Supervisord Config ──
# Runs BOTH Node.js + Python ROKET API in a single container
# Generate supervisord config at container startup via entrypoint script
# This avoids %(ENV_*)s expansion failures for optional env vars
RUN cat > /app/entrypoint.sh << 'ENTRYPOINT_EOF'
#!/bin/bash
set -e

# Build supervisord config dynamically so missing env vars get empty defaults
cat > /etc/supervisor/conf.d/roket.conf << SUPEOF
[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:roket-api]
command=/app/venv/bin/python -m uvicorn nuble.api.roket:app --host 0.0.0.0 --port 8000 --workers 2
directory=/app
environment=PYTHONPATH="/app/src:/app",AWS_REGION="${AWS_REGION:-us-east-1}",AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-}",AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-}",AWS_SESSION_TOKEN="${AWS_SESSION_TOKEN:-}",POLYGON_API_KEY="${POLYGON_API_KEY:-}",FRED_API_KEY="${FRED_API_KEY:-}"
autostart=true
autorestart=true
startretries=5
startsecs=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:node-backend]
command=node /app/node/server.js
directory=/app/node
environment=NODE_ENV="production",PORT="3000",SERVE_FRONTEND="true",FRONTEND_PATH="/app/frontend-build",ROKET_BASE_URL="http://127.0.0.1:8000",ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}",JWT_SECRET="${JWT_SECRET:-}",AWS_REGION="${AWS_REGION:-us-east-1}",AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-}",AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-}",AWS_SESSION_TOKEN="${AWS_SESSION_TOKEN:-}",ALLOWED_ORIGINS="${ALLOWED_ORIGINS:-}"
autostart=true
autorestart=true
startretries=5
startsecs=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20
SUPEOF

exec supervisord -c /etc/supervisor/supervisord.conf
ENTRYPOINT_EOF
RUN chmod +x /app/entrypoint.sh

# Environment defaults (can be overridden at runtime)
ENV NODE_ENV=production \
    PORT=3000 \
    SERVE_FRONTEND=true \
    FRONTEND_PATH=/app/frontend-build \
    ROKET_BASE_URL=http://127.0.0.1:8000

# Expose port (only Node.js is externally accessible; Python is internal)
EXPOSE 3000

# Health check — checks both Node.js AND Python ROKET API
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1

# Start entrypoint (generates supervisord config with runtime env vars, then launches supervisord)
CMD ["/app/entrypoint.sh"]
