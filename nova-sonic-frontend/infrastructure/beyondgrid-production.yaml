AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Nova Sonic Production Stack for beyondgrid.xyz
  
  Architecture: AppSync Events + Lambda + Bedrock Nova Sonic
  Following AWS Best Practices for real-time bidirectional streaming
  
  Components:
  - AppSync Events API (WebSocket for client ↔ server communication)
  - Lambda Functions (connect, publish, subscribe handlers)
  - Lambda for Bedrock Nova Sonic streaming
  - CloudFront CDN for static assets
  - S3 for static hosting
  - DynamoDB for chat history persistence
  - Cognito for authentication (optional)
  - WAF for security
  - CloudWatch for monitoring

Parameters:
  DomainName:
    Type: String
    Default: beyondgrid.xyz
    Description: Primary domain name

  HostedZoneId:
    Type: String
    Description: Route 53 Hosted Zone ID for beyondgrid.xyz

  Environment:
    Type: String
    Default: production
    AllowedValues:
      - production
      - staging
      - development
    Description: Deployment environment

  BedrockRegion:
    Type: String
    Default: us-east-1
    Description: AWS Region for Bedrock Nova Sonic

  LogRetentionDays:
    Type: Number
    Default: 30
    Description: CloudWatch log retention in days

Conditions:
  IsProduction: !Equals [!Ref Environment, 'production']

Resources:
  # ═══════════════════════════════════════════════════════════════════════════
  # S3 BUCKET - Static Website Hosting
  # ═══════════════════════════════════════════════════════════════════════════
  
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${DomainName}-website-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, HEAD]
            AllowedOrigins: ['*']
            MaxAge: 3600
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: nova-sonic

  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontAccess
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub '${WebsiteBucket.Arn}/*'
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  # ═══════════════════════════════════════════════════════════════════════════
  # CLOUDFRONT - CDN Distribution
  # ═══════════════════════════════════════════════════════════════════════════

  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub '${DomainName}-oac'
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub 'Nova Sonic CDN for ${DomainName}'
        DefaultRootObject: index.html
        PriceClass: PriceClass_100
        HttpVersion: http2and3
        
        Aliases:
          - !Ref DomainName
          - !Sub 'www.${DomainName}'
        
        ViewerCertificate:
          AcmCertificateArn: !Ref SSLCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt WebsiteBucket.RegionalDomainName
            OriginAccessControlId: !Ref CloudFrontOriginAccessControl
            S3OriginConfig:
              OriginAccessIdentity: ''
        
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD, OPTIONS]
          CachedMethods: [GET, HEAD]
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
        
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
        
        WebACLId: !If [IsProduction, !GetAtt WebACL.Arn, !Ref 'AWS::NoValue']
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # ═══════════════════════════════════════════════════════════════════════════
  # ACM CERTIFICATE - SSL/TLS
  # ═══════════════════════════════════════════════════════════════════════════

  SSLCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref DomainName
      SubjectAlternativeNames:
        - !Sub '*.${DomainName}'
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZoneId
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # ═══════════════════════════════════════════════════════════════════════════
  # DYNAMODB - Chat History & Session Storage
  # ═══════════════════════════════════════════════════════════════════════════

  ChatHistoryTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub '${DomainName}-chat-history'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProduction, true, false]
      Tags:
        - Key: Environment
          Value: !Ref Environment

  SessionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${DomainName}-sessions'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: connectionId
          AttributeType: S
        - AttributeName: sessionId
          AttributeType: S
      KeySchema:
        - AttributeName: connectionId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: sessionId-index
          KeySchema:
            - AttributeName: sessionId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # ═══════════════════════════════════════════════════════════════════════════
  # APPSYNC EVENTS API - Real-time WebSocket Communication
  # ═══════════════════════════════════════════════════════════════════════════

  AppSyncEventApi:
    Type: AWS::AppSync::Api
    Properties:
      Name: !Sub '${DomainName}-nova-sonic-events'
      EventConfig:
        AuthProviders:
          - AuthType: API_KEY
          - AuthType: AWS_IAM
        ConnectionAuthModes:
          - AuthType: API_KEY
        DefaultPublishAuthModes:
          - AuthType: API_KEY
          - AuthType: AWS_IAM
        DefaultSubscribeAuthModes:
          - AuthType: API_KEY
      Tags:
        - Key: Environment
          Value: !Ref Environment

  AppSyncApiKey:
    Type: AWS::AppSync::ApiKey
    Properties:
      ApiId: !GetAtt AppSyncEventApi.ApiId
      Description: API Key for Nova Sonic Events
      Expires: !Ref 'AWS::NoValue'  # Never expires - manage rotation separately

  # Channel Namespace for audio streaming
  AudioChannelNamespace:
    Type: AWS::AppSync::ChannelNamespace
    Properties:
      ApiId: !GetAtt AppSyncEventApi.ApiId
      Name: audio
      PublishAuthModes:
        - AuthType: API_KEY
        - AuthType: AWS_IAM
      SubscribeAuthModes:
        - AuthType: API_KEY
      CodeHandlers: |
        // OnSubscribe handler - validates subscription
        export function onSubscribe(ctx) {
          console.log('Client subscribing to audio channel:', ctx.info.channel.path);
          return {
            ...ctx.result,
            // Optionally transform or validate
          };
        }
        
        // OnPublish handler - processes audio events
        export function onPublish(ctx) {
          const events = ctx.events;
          console.log('Publishing', events.length, 'events to audio channel');
          return {
            ...ctx.result,
            events: events
          };
        }

  # Channel Namespace for session control
  SessionChannelNamespace:
    Type: AWS::AppSync::ChannelNamespace
    Properties:
      ApiId: !GetAtt AppSyncEventApi.ApiId
      Name: session
      PublishAuthModes:
        - AuthType: API_KEY
        - AuthType: AWS_IAM
      SubscribeAuthModes:
        - AuthType: API_KEY

  # ═══════════════════════════════════════════════════════════════════════════
  # LAMBDA FUNCTIONS - Business Logic
  # ═══════════════════════════════════════════════════════════════════════════

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${DomainName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:InvokeModelWithBidirectionalStream
                Resource:
                  - !Sub 'arn:aws:bedrock:${BedrockRegion}::foundation-model/amazon.nova-sonic-v1:0'
                  - !Sub 'arn:aws:bedrock:${BedrockRegion}::foundation-model/amazon.nova-2-sonic-v1:0'
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt ChatHistoryTable.Arn
                  - !Sub '${ChatHistoryTable.Arn}/index/*'
                  - !GetAtt SessionTable.Arn
                  - !Sub '${SessionTable.Arn}/index/*'
        - PolicyName: AppSyncAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - appsync:EventConnect
                  - appsync:EventPublish
                  - appsync:EventSubscribe
                Resource:
                  - !Sub 'arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/${AppSyncEventApi.ApiId}/*'

  # Nova Sonic Stream Handler Lambda
  NovaSonicStreamFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${DomainName}-nova-sonic-stream'
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 900  # 15 minutes - max for Lambda
      MemorySize: 1024
      ReservedConcurrentExecutions: 100
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          BEDROCK_REGION: !Ref BedrockRegion
          NOVA_SONIC_MODEL_ID: amazon.nova-2-sonic-v1:0
          CHAT_HISTORY_TABLE: !Ref ChatHistoryTable
          SESSION_TABLE: !Ref SessionTable
          APPSYNC_ENDPOINT: !GetAtt AppSyncEventApi.Dns.Http
          APPSYNC_REALTIME_ENDPOINT: !GetAtt AppSyncEventApi.Dns.Realtime
          APPSYNC_API_KEY: !GetAtt AppSyncApiKey.ApiKey
          NODE_OPTIONS: '--enable-source-maps'
      Code:
        ZipFile: |
          // Placeholder - will be replaced by deployment script
          exports.handler = async (event) => {
            console.log('Nova Sonic Stream Handler', JSON.stringify(event));
            return { statusCode: 200, body: 'OK' };
          };
      Tags:
        - Key: Environment
          Value: !Ref Environment

  NovaSonicStreamFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${NovaSonicStreamFunction}'
      RetentionInDays: !Ref LogRetentionDays

  # Session Manager Lambda
  SessionManagerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${DomainName}-session-manager'
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          SESSION_TABLE: !Ref SessionTable
          CHAT_HISTORY_TABLE: !Ref ChatHistoryTable
      Code:
        ZipFile: |
          // Placeholder - will be replaced by deployment script
          exports.handler = async (event) => {
            console.log('Session Manager Handler', JSON.stringify(event));
            return { statusCode: 200, body: 'OK' };
          };
      Tags:
        - Key: Environment
          Value: !Ref Environment

  SessionManagerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${SessionManagerFunction}'
      RetentionInDays: !Ref LogRetentionDays

  # ═══════════════════════════════════════════════════════════════════════════
  # API GATEWAY - REST API for Session Management
  # ═══════════════════════════════════════════════════════════════════════════

  RestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${DomainName}-api'
      Description: Nova Sonic REST API for session management
      EndpointConfiguration:
        Types:
          - REGIONAL
      Tags:
        - Key: Environment
          Value: !Ref Environment

  ApiResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApi
      ParentId: !GetAtt RestApi.RootResourceId
      PathPart: session

  ApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref RestApi
      ResourceId: !Ref ApiResource
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SessionManagerFunction.Arn}/invocations'

  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn: ApiMethod
    Properties:
      RestApiId: !Ref RestApi

  ApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref RestApi
      DeploymentId: !Ref ApiDeployment
      StageName: !Ref Environment
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          MetricsEnabled: true

  SessionManagerFunctionApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SessionManagerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*'

  # ═══════════════════════════════════════════════════════════════════════════
  # WAF - Web Application Firewall (Production Only)
  # ═══════════════════════════════════════════════════════════════════════════

  WebACL:
    Type: AWS::WAFv2::WebACL
    Condition: IsProduction
    Properties:
      Name: !Sub '${DomainName}-waf'
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub '${DomainName}-waf'
      Rules:
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CommonRuleSet
        - Name: AWSManagedRulesKnownBadInputsRuleSet
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: KnownBadInputs
        - Name: RateLimitRule
          Priority: 3
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimit
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # ═══════════════════════════════════════════════════════════════════════════
  # ROUTE 53 - DNS Records
  # ═══════════════════════════════════════════════════════════════════════════

  DNSRecordRoot:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)

  DNSRecordWWW:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub 'www.${DomainName}'
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2

  DNSRecordApi:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub 'api.${DomainName}'
      Type: A
      AliasTarget:
        DNSName: !Sub '${RestApi}.execute-api.${AWS::Region}.amazonaws.com'
        HostedZoneId: !Ref ApiGatewayHostedZoneId

  # API Gateway regional hosted zone lookup
  ApiGatewayHostedZoneId:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/${DomainName}/api-gateway-hosted-zone'
      Type: String
      Value: Z1UJRXOUMOOFQ8  # us-east-1 API Gateway hosted zone

  # ═══════════════════════════════════════════════════════════════════════════
  # CLOUDWATCH - Monitoring & Alarms
  # ═══════════════════════════════════════════════════════════════════════════

  NovaSonicErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsProduction
    Properties:
      AlarmName: !Sub '${DomainName}-nova-sonic-errors'
      AlarmDescription: Alert when Nova Sonic Lambda has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref NovaSonicStreamFunction
      TreatMissingData: notBreaching

  HighLatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsProduction
    Properties:
      AlarmName: !Sub '${DomainName}-high-latency'
      AlarmDescription: Alert when Lambda duration exceeds threshold
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 3
      Threshold: 30000  # 30 seconds
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref NovaSonicStreamFunction
      TreatMissingData: notBreaching

  # Dashboard
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: IsProduction
    Properties:
      DashboardName: !Sub '${DomainName}-nova-sonic'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0, "y": 0, "width": 12, "height": 6,
              "properties": {
                "title": "Lambda Invocations",
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${NovaSonicStreamFunction}"],
                  [".", "Errors", ".", "."],
                  [".", "Throttles", ".", "."]
                ],
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            },
            {
              "type": "metric",
              "x": 12, "y": 0, "width": 12, "height": 6,
              "properties": {
                "title": "Lambda Duration",
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${NovaSonicStreamFunction}"]
                ],
                "region": "${AWS::Region}",
                "stat": "Average",
                "period": 60
              }
            },
            {
              "type": "metric",
              "x": 0, "y": 6, "width": 12, "height": 6,
              "properties": {
                "title": "AppSync Events",
                "metrics": [
                  ["AWS/AppSync", "PublishEventSuccess", "ApiId", "${AppSyncEventApi.ApiId}"],
                  [".", "SubscribeEventSuccess", ".", "."],
                  [".", "ConnectEventSuccess", ".", "."]
                ],
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            },
            {
              "type": "metric",
              "x": 12, "y": 6, "width": 12, "height": 6,
              "properties": {
                "title": "DynamoDB",
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${ChatHistoryTable}"],
                  [".", "ConsumedWriteCapacityUnits", ".", "."]
                ],
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            }
          ]
        }

# ═══════════════════════════════════════════════════════════════════════════
# OUTPUTS
# ═══════════════════════════════════════════════════════════════════════════

Outputs:
  WebsiteURL:
    Description: Website URL
    Value: !Sub 'https://${DomainName}'
    Export:
      Name: !Sub '${AWS::StackName}-WebsiteURL'

  CloudFrontDistributionId:
    Description: CloudFront Distribution ID
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontDistributionId'

  CloudFrontDomainName:
    Description: CloudFront Domain Name
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-CloudFrontDomainName'

  S3BucketName:
    Description: S3 Bucket for website files
    Value: !Ref WebsiteBucket
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketName'

  AppSyncEventApiEndpoint:
    Description: AppSync Events HTTP Endpoint
    Value: !GetAtt AppSyncEventApi.Dns.Http
    Export:
      Name: !Sub '${AWS::StackName}-AppSyncHttpEndpoint'

  AppSyncRealtimeEndpoint:
    Description: AppSync Events WebSocket Endpoint
    Value: !GetAtt AppSyncEventApi.Dns.Realtime
    Export:
      Name: !Sub '${AWS::StackName}-AppSyncRealtimeEndpoint'

  AppSyncApiId:
    Description: AppSync Event API ID
    Value: !GetAtt AppSyncEventApi.ApiId
    Export:
      Name: !Sub '${AWS::StackName}-AppSyncApiId'

  AppSyncApiKey:
    Description: AppSync API Key (store securely!)
    Value: !GetAtt AppSyncApiKey.ApiKey
    Export:
      Name: !Sub '${AWS::StackName}-AppSyncApiKey'

  RestApiEndpoint:
    Description: REST API Endpoint
    Value: !Sub 'https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-RestApiEndpoint'

  ChatHistoryTableName:
    Description: DynamoDB Chat History Table
    Value: !Ref ChatHistoryTable
    Export:
      Name: !Sub '${AWS::StackName}-ChatHistoryTable'

  SessionTableName:
    Description: DynamoDB Session Table
    Value: !Ref SessionTable
    Export:
      Name: !Sub '${AWS::StackName}-SessionTable'

  NovaSonicFunctionArn:
    Description: Nova Sonic Stream Function ARN
    Value: !GetAtt NovaSonicStreamFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-NovaSonicFunctionArn'

  SSLCertificateArn:
    Description: ACM Certificate ARN
    Value: !Ref SSLCertificate
    Export:
      Name: !Sub '${AWS::StackName}-SSLCertificateArn'
