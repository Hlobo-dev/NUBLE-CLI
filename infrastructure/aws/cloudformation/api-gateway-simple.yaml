AWSTemplateFormatVersion: '2010-09-09'
Description: 'NUBLE ELITE - API Gateway HTTP API'

Parameters:
  Environment:
    Type: String
    Default: production
  
  SignalValidatorLambdaArn:
    Type: String
    Description: ARN of the Signal Validator Lambda function

Resources:
  # ============ API Gateway HTTP API ============
  NubleAPI:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub nuble-${Environment}-api
      ProtocolType: HTTP
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - POST
          - GET
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - X-Amz-Date
          - Authorization
          - X-Api-Key
      Tags:
        Environment: !Ref Environment

  # ============ Lambda Integration ============
  SignalValidatorIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref NubleAPI
      IntegrationType: AWS_PROXY
      IntegrationUri: !Ref SignalValidatorLambdaArn
      PayloadFormatVersion: '2.0'
      TimeoutInMillis: 29000

  # ============ Routes ============
  WebhookRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref NubleAPI
      RouteKey: POST /webhook
      AuthorizationType: NONE
      Target: !Sub integrations/${SignalValidatorIntegration}

  WebhookMTFRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref NubleAPI
      RouteKey: POST /webhook/mtf
      AuthorizationType: NONE
      Target: !Sub integrations/${SignalValidatorIntegration}

  HealthRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref NubleAPI
      RouteKey: GET /health
      AuthorizationType: NONE
      Target: !Sub integrations/${SignalValidatorIntegration}

  SignalsRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref NubleAPI
      RouteKey: GET /signals
      AuthorizationType: NONE
      Target: !Sub integrations/${SignalValidatorIntegration}

  DecisionsRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref NubleAPI
      RouteKey: GET /decisions
      AuthorizationType: NONE
      Target: !Sub integrations/${SignalValidatorIntegration}

  # ============ Stage with Rate Limiting ============
  ProductionStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref NubleAPI
      StageName: !Ref Environment
      AutoDeploy: true
      DefaultRouteSettings:
        ThrottlingBurstLimit: 100
        ThrottlingRateLimit: 50
      AccessLogSettings:
        DestinationArn: !GetAtt APIGatewayLogGroup.Arn
        Format: >-
          {"requestId":"$context.requestId","ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime","httpMethod":"$context.httpMethod",
          "routeKey":"$context.routeKey","status":"$context.status",
          "responseLength":"$context.responseLength","integrationLatency":"$context.integrationLatency"}
      Tags:
        Environment: !Ref Environment

  # ============ CloudWatch Log Group ============
  APIGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/nuble-${Environment}
      RetentionInDays: 30

  # ============ CloudWatch Alarms ============
  API5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub nuble-${Environment}-api-5xx-errors
      AlarmDescription: Triggers when 5xx errors exceed threshold
      MetricName: 5xx
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiId
          Value: !Ref NubleAPI
      TreatMissingData: notBreaching

  APILatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub nuble-${Environment}-api-high-latency
      AlarmDescription: Triggers when latency exceeds threshold
      MetricName: Latency
      Namespace: AWS/ApiGateway
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 3000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiId
          Value: !Ref NubleAPI
      TreatMissingData: notBreaching

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${NubleAPI}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
    Export:
      Name: !Sub ${AWS::StackName}-ApiEndpoint

  WebhookUrl:
    Description: Webhook URL for TradingView alerts
    Value: !Sub https://${NubleAPI}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/webhook
    Export:
      Name: !Sub ${AWS::StackName}-WebhookUrl

  ApiId:
    Description: API Gateway ID
    Value: !Ref NubleAPI
    Export:
      Name: !Sub ${AWS::StackName}-ApiId
